<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Test</title>
	<link href="mocha.css" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
	<div id="mocha"></div>

	<section id='test'></section>
	<script src="mocha/mocha.js"></script>
	<script src="proclaim/lib/proclaim.js"></script>
	<script src="async-define/async-define.js"></script>
	<script src="events-amd/events-amd.js"></script>
	<script src="doc-amd/doc.js"></script>
	<script src="tag.js"></script>

	<script>
		var COMMA = 188,
			ENTER = 13,
			TAB = 9,
			BACKSPACE = 8,
			DELETE = 46,
			LEFT_KEY = 37,
			RIGHT_KEY = 39,
			CHAR_A = 65,
			SPACEBAR = 32;
		var type = function(element, keyCode) {
			var evt;
			try {
				evt = new Event('keydown');
			} catch (e) {
				evt = document.createEvent('Event');
				evt.initEvent('keydown', true, false);
			}
			evt.which = keyCode;
			evt.keyCode = keyCode;

			element.dispatchEvent(evt);
		};
	</script>

	<script>
		var assert = proclaim;
		mocha.ui('bdd');

		define(['doc', 'tag'], function($, tag) {
			var input;

			describe('Tagify method', function() {
				beforeEach(function() {
					$('#test').html('<input id="tags" name="tags-name">')
					input = $('#test').find('#tags');
				});

				it('should create a single tag from a filled input', function() {
					input.val('tag1');
					var tagged = tag.tagify('#tags');
					assert.deepEqual(tagged.tags(), ['tag1']);
				});
				it('should create two tags from a filled input, splitted with comma', function() {
					input.val('tag1,another-tag');
					var tagged = tag.tagify('#tags');
					assert.deepEqual(tagged.tags(), ['tag1', 'another-tag']);
				});
				it('should create two tags from a filled input, splitted with a spaced comma', function() {
					input.val('tag1, another-tag');
					var tagged = tag.tagify('#tags');
					assert.deepEqual(tagged.tags(), ['tag1', 'another-tag']);
				});
				it('should create two tags from a filled input, one of them with spaces, splitted with a spaced comma', function() {
					input.val('tag1, another tag');
					var tagged = tag.tagify('#tags');
					assert.deepEqual(tagged.tags(), ['tag1', 'another tag']);
				});
				it('should create some tags from a filled input, removing empty tags', function() {
					input.val('tag1, another tag, tag2,, another another , ,');
					var tagged = tag.tagify('#tags');
					assert.deepEqual(tagged.tags(), ['tag1', 'another tag', 'tag2', 'another another']);
				});
			});

			describe('Typing in a tagified input', function() {
				beforeEach(function() {
					$('#test').html('<input id="tags" name="tags-name">')
					input = $('#test').find('#tags');
				});

				it('should create a new tag when a comma is typed', function() {
					var tagged = tag.tagify('#tags');
					input.val('tag1');
					assert.lengthEquals(tagged.tags(), 0);
					type(input.first(), COMMA);
					assert.deepEqual(tagged.tags(), ['tag1']);
				});

				it('should not duplicate tag', function() {
					input.val('tag1');
					var tagged = tag.tagify('#tags');
					type(input.first(), COMMA);
					assert.deepEqual(tagged.tags(), ['tag1']);
				});

				it('should create a new tag when enter is typed', function() {
					var tagged = tag.tagify('#tags');
					input.val('tag1');
					assert.lengthEquals(tagged.tags(), 0);
					type(input.first(), ENTER);
					assert.deepEqual(tagged.tags(), ['tag1']);
				});

				it('should create a new tag when tab is typed', function() {
					var tagged = tag.tagify('#tags');
					input.val('tag1');
					assert.lengthEquals(tagged.tags(), 0);
					type(input.first(), TAB);
					assert.deepEqual(tagged.tags(), ['tag1']);
				});

				it('should not remove last tag when has text and backspace is typed', function() {
					input.val('tag1, tag2');
					var tagged = tag.tagify('#tags');
					input.val(input.val() + 'another-tag');
					assert.lengthEquals(tagged.tags(), 2);
					type(input.first(), BACKSPACE);
					assert.deepEqual(tagged.tags(), ['tag1', 'tag2']);
				});

				it('should do nothing when backspace is typed and there are no tags', function() {
					var tagged = tag.tagify('#tags');
					assert.lengthEquals(tagged.tags(), 0);
					type(input.first(), BACKSPACE);
					assert.lengthEquals(tagged.tags(), 0);
				});

				it('should add all tags in the input when comma is typed', function() {
					var tagged = tag.tagify('#tags');
					assert.lengthEquals(tagged.tags(), 0);
					input.val('tag1, another tag');
					type(input.first(), COMMA);
					assert.deepEqual(tagged.tags(), ['tag1', 'another tag']);
				});

				it('should add all unique tags in the input when comma is typed and there are repeated tags', function() {
					var tagged = tag.tagify('#tags');
					assert.lengthEquals(tagged.tags(), 0);
					input.val('tag1, another tag, tag1, yet another');
					type(input.first(), COMMA);
					assert.deepEqual(tagged.tags(), ['tag1', 'another tag', 'yet another']);
				});

				it('should add tag when key and comma is typed', function() {
					var tagged = tag.tagify('#tags');
					input.val('tag1');
					type(input.first(), COMMA);
					type(input.first(), CHAR_A);
					input.val(input.val() + 'a'); // Simulate typing
					type(input.first(), COMMA);
					assert.deepEqual(tagged.tags(), ['tag1', 'a']);
				});
			});

			describe('Selecting tags of a tagified input', function() {
				beforeEach(function() {
					$('#test').html('<input id="tags" name="tags-name">')
					input = $('#test').find('#tags');
				});

				it('should have no selected tags after activated', function() {
					input.val('tag1, tag-to-remove');
					var tagged = tag.tagify('#tags');
					assert.isNull(tagged.selected());
				});

				it('should not select tags when pressing left key if input is filled', function() {
					input.val('tag1, another');
					var tagged = tag.tagify('#tags');
					input.val('tag2');
					type(input.first(), LEFT_KEY);
					assert.isNull(tagged.selected());
				});

				it('should not select tags if none is selected and right key is pressed', function() {
					input.val('tag1, tag-to-remove');
					var tagged = tag.tagify('#tags');
					assert.isNull(tagged.selected());
					type(input.first(), RIGHT_KEY);
					assert.isNull(tagged.selected());
				});

				it('should not select tags when pressing right key if input is filled', function() {
					input.val('tag1, another');
					var tagged = tag.tagify('#tags');
					input.val('tag2');
					type(input.first(), RIGHT_KEY);
					assert.isNull(tagged.selected());
				});

				it('should select the last tag when pressing left key if input is empty', function() {
					input.val('tag1, another');
					var tagged = tag.tagify('#tags');
					input.val('');
					type(input.first(), LEFT_KEY);
					assert.equal(tagged.selected(), 'another');
				});

				it('should select the tag before when pressing left key with a tag selected', function() {
					input.val('tag1, another');
					var tagged = tag.tagify('#tags');
					input.val('');
					type(input.first(), LEFT_KEY);
					type(input.first(), LEFT_KEY);
					assert.equal(tagged.selected(), 'tag1');
				});

				it('should keep the first tag selected when pressing left key with the first tag selected', function() {
					input.val('tag1, another');
					var tagged = tag.tagify('#tags');
					input.val('');
					type(input.first(), LEFT_KEY);
					type(input.first(), LEFT_KEY);
					type(input.first(), LEFT_KEY);
					assert.equal(tagged.selected(), 'tag1');
				});

				it('should deselect the last tag if it was previously selected when the right key is pressed', function() {
					input.val('tag1, another');
					var tagged = tag.tagify('#tags');
					input.val('');
					type(input.first(), LEFT_KEY);
					type(input.first(), RIGHT_KEY);
					assert.isNull(tagged.selected());
				});

				it('should select the next tag when the right key is pressed and there is next tag', function() {
					input.val('tag1, another');
					var tagged = tag.tagify('#tags');
					input.val('');
					type(input.first(), LEFT_KEY);
					type(input.first(), LEFT_KEY);
					type(input.first(), RIGHT_KEY);
					assert.equal(tagged.selected(), 'another');
				});

				it('should remove tag when close button was clicked', function() {
					input.val('tag1, another');
					var tagged = tag.tagify('#tags');
					$('.tag .close').first().click();
					assert.equal(tagged.tags(), 'another');
				});
			});

			describe('When tagging', function() {
				beforeEach(function() {
					$('#test').html('<input id="tags" name="tags-name">')
					input = $('#test').find('#tags');
				});

				it('should add a new li with tag as value', function() {
					input.val('tag');
					tag.tagify('#tags');
					assert.notOk($('input[value="tag"]').isEmpty());
				});

				it('should add a another li with another tag as value', function() {
					input.val('tag, another-tag');
					tag.tagify('#tags');
					assert.notOk($('input[value="tag"]').isEmpty());
					assert.notOk($('input[value="another-tag"]').isEmpty());
				});

				it('should remove tag on backspace', function() {
					input.val('tag');
					tag.tagify('#tags');
					type(input.first(), BACKSPACE);
					assert.ok($('input[value="tag"]').isEmpty());
				});

				it('should add an error class when trying to add repeated tag', function() {
					input.val('tag');
					tag.tagify('#tags');
					input.val('tag');
					type(input.first(), COMMA);
					assert.equal($('.tags').find('.tag').size, 1);
					assert.ok(input.hasClass('error'));
				});

				it('should remove error class when trying to add repeated tag and typing another letter', function() {
					input.val('tag');
					tag.tagify('#tags');
					input.val('tag');
					type(input.first(), COMMA);
					type(input.first(), CHAR_A);
					assert.equal($('.tags').find('.tag').size, 1);
					assert.notOk(input.hasClass('error'));
				});

				it('should focus on second tag when typing left arrow key', function() {
					input.val('tag, tag2');
					tag.tagify('#tags');
					type(input.first(), LEFT_KEY);
					assert.equal($('.tag.selected').first(), $('input[value="tag2"]').parent().first());
				});

				it('should focus on first tag when typing left arrow key two times', function() {
					input.val('tag, tag2');
					tag.tagify('#tags');
					type(input.first(), LEFT_KEY);
					type(input.first(), LEFT_KEY);
					assert.equal($('.tag.selected').first(), $('input[value="tag"]').parent().first());
				});

				it('should remove first tag when typing left arrow key two times and pressing backspace', function() {
					input.val('tag, tag2');
					tag.tagify('#tags');
					type(input.first(), LEFT_KEY);
					type(input.first(), LEFT_KEY);
					type(input.first(), BACKSPACE);
					assert.equal($('.tag').size, 1);
					assert.notOk($('input[value="tag2"]').isEmpty());
				});

				it('should remove first tag when typing left arrow key two times and pressing delete', function() {
					input.val('tag, tag2');
					tag.tagify('#tags');
					type(input.first(), LEFT_KEY);
					type(input.first(), LEFT_KEY);
					type(input.first(), DELETE);
					assert.equal($('.tag').size, 1);
					assert.notOk($('input[value="tag2"]').isEmpty());
				});

				it('should not add empty tag', function() {
					input.val(' ');
					tag.tagify('#tags');
					type(input.first(), ENTER);
					assert.equal($('.tag').size, 0);
				});
			});
		});
	</script>

	<script>
		if (window.mochaPhantomJS) {
			mochaPhantomJS.run();
		} else {
			mocha.run();
		}
	</script>
</body>
</html>
